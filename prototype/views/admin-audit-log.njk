{% extends "layout.njk" %}

{% block pageTitle %}Audit Log{% endblock %}

{% block content %}
<div class="govuk-width-container">
  <main class="govuk-main-wrapper" id="main-content" role="main">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-xl">Audit Log</h1>
        
        <p class="govuk-body">All create, edit, and delete events for components and features.</p>
        
        {% if logs.length === 0 %}
        <p class="govuk-body">No audit log entries yet.</p>
        {% else %}
        
        <table class="govuk-table">
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header">Timestamp</th>
              <th scope="col" class="govuk-table__header">User</th>
              <th scope="col" class="govuk-table__header">Action</th>
              <th scope="col" class="govuk-table__header">Entity Type</th>
              <th scope="col" class="govuk-table__header">Entity ID</th>
              <th scope="col" class="govuk-table__header">Details</th>
              <th scope="col" class="govuk-table__header">Actions</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for log in logs %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ log.timestamp | replace('T', ' ') | replace('.000Z', '') }}</td>
              <td class="govuk-table__cell"><strong>{{ log.username or 'Unknown' }}</strong></td>
              <td class="govuk-table__cell">
                {% if log.action_type === 'create' %}
                  <strong class="govuk-tag govuk-tag--green">CREATE</strong>
                {% elif log.action_type === 'edit' %}
                  <strong class="govuk-tag govuk-tag--blue">EDIT</strong>
                {% elif log.action_type === 'delete' %}
                  <strong class="govuk-tag govuk-tag--red">DELETE</strong>
                {% endif %}
              </td>
              <td class="govuk-table__cell">{{ log.entity_type }}</td>
              <td class="govuk-table__cell"><code>{{ log.entity_id }}</code></td>
              <td class="govuk-table__cell" style="max-width: 400px;">
                {% if log.action_type === 'create' and log.new_data_parsed %}
                  <details class="govuk-details" data-module="govuk-details">
                    <summary class="govuk-details__summary">
                      <span class="govuk-details__summary-text">View created data</span>
                    </summary>
                    <div class="govuk-details__text">
                      {% if log.entity_type === 'component' %}
                        <strong>Code:</strong> {{ log.new_data_parsed.component_code }}<br>
                        <strong>Name:</strong> {{ log.new_data_parsed.component_name }}
                      {% elif log.entity_type === 'feature' %}
                        <strong>Name:</strong> {{ log.new_data_parsed.feature_name }}<br>
                        <strong>Description:</strong> {{ log.new_data_parsed.description | truncate(100) }}
                      {% endif %}
                    </div>
                  </details>
                {% elif log.action_type === 'edit' and log.old_data_parsed and log.new_data_parsed %}
                  <details class="govuk-details" data-module="govuk-details">
                    <summary class="govuk-details__summary">
                      <span class="govuk-details__summary-text">View changes</span>
                    </summary>
                    <div class="govuk-details__text">
                      {% if log.entity_type === 'component' %}
                        <strong>Old name:</strong> {{ log.old_data_parsed.component_name }}<br>
                        <strong>New name:</strong> {{ log.new_data_parsed.component_name }}
                      {% elif log.entity_type === 'feature' %}
                        <strong>Old name:</strong> {{ log.old_data_parsed.feature_name }}<br>
                        <strong>New name:</strong> {{ log.new_data_parsed.feature_name }}
                      {% endif %}
                    </div>
                  </details>
                {% elif log.action_type === 'delete' and log.old_data_parsed %}
                  <details class="govuk-details" data-module="govuk-details">
                    <summary class="govuk-details__summary">
                      <span class="govuk-details__summary-text">View deleted data</span>
                    </summary>
                    <div class="govuk-details__text">
                      {% if log.entity_type === 'component' %}
                        <strong>Code:</strong> {{ log.old_data_parsed.component_code }}<br>
                        <strong>Name:</strong> {{ log.old_data_parsed.component_name }}
                      {% elif log.entity_type === 'feature' %}
                        <strong>Name:</strong> {{ log.old_data_parsed.feature_name }}<br>
                        <strong>Description:</strong> {{ log.old_data_parsed.description | truncate(100) }}
                      {% endif %}
                    </div>
                  </details>
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if log.action_type === 'edit' %}
                  <form action="/admin/audit-log/{{ log.id }}/revert-edit" method="post" style="display: inline;">
                    <button type="submit" class="govuk-button govuk-button--secondary govuk-button--small" data-module="govuk-button" 
                      onclick="return confirm('Are you sure you want to revert this edit? This will restore the previous data.');">
                      Revert
                    </button>
                  </form>
                {% elif log.action_type === 'delete' %}
                  <form action="/admin/audit-log/{{ log.id }}/revert-delete" method="post" style="display: inline;">
                    <button type="submit" class="govuk-button govuk-button--secondary govuk-button--small" data-module="govuk-button"
                      onclick="return confirm('Are you sure you want to restore this deleted {{ log.entity_type }}?');">
                      Restore
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
        
        <p class="govuk-body" style="margin-top: 40px;">
          <a href="/admin" class="govuk-link">Back to admin dashboard</a>
        </p>
      </div>
    </div>
  </main>
</div>
{% endblock %}
